<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Expense Tracker — Firebase Sync</title>
<style>
  :root{--bg:#f4f6f8;--card:#fff;--muted:#666}
  body{font-family:Inter,Segoe UI,Arial; margin:18px; background:var(--bg); color:#111}
  header {display:flex;align-items:center;justify-content:space-between;gap:12px}
  h1{background:#0b5ed7;color:#fff;padding:10px 14px;border-radius:6px;display:inline-block;margin:0}
  .grid{display:grid;grid-template-columns:1fr 420px;gap:14px;margin-top:14px}
  .card{background:var(--card);padding:12px;border-radius:8px;box-shadow:0 1px 6px rgba(0,0,0,.06)}
  label{display:block;font-size:13px;margin-top:8px;color:var(--muted)}
  input[type="text"], input[type="number"], input[type="datetime-local"], select {
    width:100%;padding:8px;margin-top:6px;border:1px solid #d6dce3;border-radius:6px;
  }
  button{margin-top:10px;padding:8px 10px;border-radius:6px;border:0;background:#0b5ed7;color:white;cursor:pointer}
  .small{font-size:13px;color:var(--muted)}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px;border-bottom:1px solid #eee;text-align:left;font-size:13px}
  th{background:#f8fbff}
  .summary-row{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
  .pill{background:#f1f5ff;padding:8px 10px;border-radius:8px;font-weight:600}
  .top-badge{background:#fff3cd;color:#856404;padding:6px;border-radius:6px;margin-top:8px;display:inline-block}
  canvas{width:100%!important;height:220px!important;display:block;margin-top:8px}
  .legend {margin-top:6px;font-size:13px;}
  .legend-item{display:flex;align-items:center;margin-bottom:4px;}
  .legend-box{width:14px;height:14px;margin-right:6px;border-radius:3px;}
  .user-row{display:flex;gap:8px;align-items:center}
  .btn-quiet{background:#6c757d;color:white}
  #status {font-size:13px;color:#555;margin-left:8px}
  .toast{position:fixed;right:18px;bottom:18px;background:#222;color:#fff;padding:8px 12px;border-radius:6px;opacity:.95}
  @media(max-width:860px){ .grid{grid-template-columns:1fr;} }
</style>
</head>
<body>

<header>
  <div>
    <h1>Expense Tracker</h1>
    <div class="small">Cloud-sync with Firebase — sign in to sync across devices</div>
  </div>
  <div class="user-row card" style="padding:10px">
    <div id="userArea">
      <button id="signInBtn" onclick="signIn()">Sign in with Google</button>
    </div>
    <div id="status">Not signed in</div>
  </div>
</header>

<div class="grid">
  <!-- LEFT: INPUTS + LOG -->
  <div class="card" id="mainCard">
    <h3>Add / Manage Categories</h3>

    <label>New Income Category</label>
    <input id="newIncomeCategory" type="text" placeholder="e.g., Freelance">
    <button onclick="addCategory('income')">Add Income Category</button>

    <label style="margin-top:10px">New Expense Category</label>
    <input id="newExpenseCategory" type="text" placeholder="e.g., Groceries">
    <button onclick="addCategory('expense')">Add Expense Category</button>

    <hr>

    <h3>Add Transaction</h3>
    <label>Type</label>
    <select id="txType" onchange="refreshCategorySelects()">
      <option value="Expense">Expense</option>
      <option value="Income">Income</option>
    </select>

    <label>Category</label>
    <select id="txCategory"></select>

    <div style="display:flex;gap:8px">
      <div style="flex:1">
        <label>Amount</label>
        <input id="txAmount" type="number" placeholder="100.00" step="0.01">
      </div>
      <div style="width:220px">
        <label>Date & Time</label>
        <input id="txDate" type="datetime-local">
      </div>
    </div>

    <label>Note</label>
    <input id="txNote" type="text" placeholder="optional">

    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button onclick="addTransaction()">Add Transaction</button>
      <button onclick="exportCSV()" style="background:#198754">Export CSV</button>
      <button onclick="clearAll()" style="background:#dc3545">Clear All Data</button>
    </div>

    <hr>

    <h3>Summary</h3>
    <div class="summary-row">
      <div class="pill">Income: <span id="totalIncome">0</span></div>
      <div class="pill">Expense: <span id="totalExpense">0</span></div>
      <div class="pill">Balance: <span id="balance">0</span></div>
    </div>

    <p class="small">Top Income: <span id="topIncome" class="top-badge">-</span></p>
    <p class="small">Top Expense: <span id="topExpense" class="top-badge">-</span></p>

    <hr>

    <h3>Transaction Log</h3>
    <div class="small">Most recent first. Changes auto-sync across devices.</div>
    <table id="txTable" aria-live="polite">
      <thead><tr><th>Type</th><th>Category</th><th>Amount</th><th>Date & time</th><th>Note</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- RIGHT: CHARTS -->
  <div class="card">
    <h3>Charts</h3>

    <strong>Income Breakdown</strong>
    <canvas id="incomeCanvas"></canvas>
    <div id="incomeLegend" class="legend"></div>

    <strong style="margin-top:10px;display:block">Expense Breakdown</strong>
    <canvas id="expenseCanvas"></canvas>
    <div id="expenseLegend" class="legend"></div>
  </div>
</div>

<div id="toast" class="toast" style="display:none"></div>

<!-- Firebase SDKs (modules) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
  import {
    getFirestore, enableIndexedDbPersistence,
    collection, addDoc, onSnapshot, query, orderBy,
    doc, setDoc, getDoc, deleteDoc
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDsNmjIXjrS7RnFHe3c2t8r3dVgVNgZBAc",
    authDomain: "expense-tracker-5a003.firebaseapp.com",
    projectId: "expense-tracker-5a003",
    storageBucket: "expense-tracker-5a003.firebasestorage.app",
    messagingSenderId: "857816952226",
    appId: "1:857816952226:web:27e965a1ef7bcfcafe16fb",
    measurementId: "G-F1JLDR4FHJ"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  try { enableIndexedDbPersistence(db); } catch(e){ console.warn("IndexedDB persistence not available", e); }

  // local mirrors
  let categories = { income: ["Salary","Bank Interest"], expense: ["Fuel","Medicine","House Rent","Card Bill","Food"] };
  let transactions = []; // array of tx objects
  let currentUser = null;
  let unsubTransactions = null;
  let unsubMeta = null;

  // UI refs
  const userArea = document.getElementById("userArea");
  const statusEl = document.getElementById("status");
  const toastEl = document.getElementById("toast");

  function showToast(msg, t=2500){
    toastEl.textContent = msg; toastEl.style.display = "block";
    clearTimeout(showToast._t); showToast._t = setTimeout(()=>{ toastEl.style.display="none"; }, t);
  }

  // Auth
  window.signIn = async function(){
    const provider = new GoogleAuthProvider();
    try {
      await signInWithPopup(auth, provider);
    } catch(e){ alert("Sign-in failed: "+(e.message||e)); console.error(e); }
  };
  window.signOutUser = async function(){
    if(!currentUser) return;
    await signOut(auth);
  };

  onAuthStateChanged(auth, async user => {
    currentUser = user;
    if(user){
      statusEl.textContent = "Signed in: " + (user.displayName||user.email);
      userArea.innerHTML = `
        <div style="display:flex;align-items:center;gap:8px">
          <img src="${user.photoURL||''}" style="width:36px;height:36px;border-radius:50%" alt="">
          <div style="display:flex;flex-direction:column">
            <strong style="font-size:14px">${user.displayName||user.email}</strong>
            <small style="color:#666">${user.email}</small>
          </div>
        </div>
        <div style="margin-left:8px">
          <button id="signOutBtn" class="btn-quiet" style="background:#6c757d" onclick="signOutUser()">Sign Out</button>
        </div>`;
      // attach listeners
      attachMetaListener();
      attachTransactionsListener();
    } else {
      statusEl.textContent = "Not signed in";
      userArea.innerHTML = `<button id="signInBtn" onclick="signIn()">Sign in with Google</button>`;
      detachListeners();
      // reset local state
      categories = { income: ["Salary","Bank Interest"], expense: ["Fuel","Medicine","House Rent","Card Bill","Food"] };
      transactions = [];
      renderAll();
    }
  });

  // Firestore helpers: paths
  function metaDocRef(uid){ return doc(db, "users", uid, "private", "meta"); }
  function transactionsCollRef(uid){ return collection(db, "users", uid, "transactions"); }

  // Listen to categories/meta doc
  function attachMetaListener(){
    if(!currentUser) return;
    const ref = metaDocRef(currentUser.uid);
    if(unsubMeta) unsubMeta();
    unsubMeta = onSnapshot(ref, snap=>{
      if(snap.exists()){
        const d = snap.data();
        categories = d.categories || categories;
      } else {
        // create meta if not present
        setDoc(ref, { categories }).catch(e=>console.error("meta create error",e));
      }
      renderAll();
    }, err=>{
      console.error("meta snapshot error", err);
    });
  }

  // Listen to transactions collection in real-time
  function attachTransactionsListener(){
    if(!currentUser) return;
    const col = transactionsCollRef(currentUser.uid);
    const q = query(col, orderBy("datetime", "desc"));
    if(unsubTransactions) unsubTransactions();
    unsubTransactions = onSnapshot(q, snap=>{
      const arr = [];
      snap.forEach(docSnap=>{
        const d = docSnap.data();
        d._id = docSnap.id;
        arr.push(d);
      });
      transactions = arr; renderAll();
      console.log("transactions snapshot, count=", transactions.length);
    }, err=>{
      console.error("transactions snapshot error", err);
    });
  }

  function detachListeners(){
    if(unsubTransactions){ unsubTransactions(); unsubTransactions = null; }
    if(unsubMeta){ unsubMeta(); unsubMeta = null; }
  }

  // Add category -> save to meta doc
  window.addCategory = async function(kind){
    const id = kind==="income" ? "newIncomeCategory" : "newExpenseCategory";
    const val = document.getElementById(id).value.trim();
    if(!val) return alert("Enter category name");
    if((categories[kind]||[]).includes(val)) { alert("Category exists"); return; }
    categories[kind] = categories[kind]||[]; categories[kind].push(val);
    document.getElementById(id).value = "";
    if(!currentUser){ showToast("Sign in to save categories"); renderAll(); return; }
    try {
      await setDoc(metaDocRef(currentUser.uid), { categories }, { merge: true });
      showToast("Category saved");
    } catch(e){ alert("Could not save category: "+e.message); console.error(e); }
    renderAll();
  };

  // Add one transaction (writes to transactions subcollection)
  window.addTransaction = async function(){
    const type = document.getElementById("txType").value;
    const category = document.getElementById("txCategory").value;
    const amount = parseFloat(document.getElementById("txAmount").value);
    const datetime = document.getElementById("txDate").value;
    const note = document.getElementById("txNote").value.trim();
    if(!category || !datetime || !amount || isNaN(amount)) return alert("Enter Type, Category, Amount and Date & Time.");
    const tx = {
      type, category, amount: Number(amount),
      datetime, note,
      createdAt: Date.now()
    };
    if(!currentUser){ showToast("Sign in to save transactions"); return; }
    try {
      const col = transactionsCollRef(currentUser.uid);
      await addDoc(col, tx);
      showToast("Transaction saved");
      // clear inputs
      document.getElementById("txAmount").value=""; document.getElementById("txNote").value=""; document.getElementById("txDate").value="";
    } catch(e){
      alert("Error saving transaction: " + (e.message||e)); console.error(e);
    }
  };

  // Delete single transaction document
  window.deleteTx = async function(docId){
    if(!confirm("Delete this entry?")) return;
    if(!currentUser){ showToast("Sign in to delete"); return; }
    try {
      await deleteDoc(doc(db, "users", currentUser.uid, "transactions", docId));
      showToast("Deleted");
    } catch(e){ alert("Delete failed: "+e.message); console.error(e); }
  };

  // Clear everything for this user (meta + transactions)
  window.clearAll = async function(){
    if(!confirm("Clear ALL data for this account? This deletes categories and all transactions.")) return;
    if(!currentUser){ showToast("Sign in to clear data"); return; }
    try {
      // delete meta
      await setDoc(metaDocRef(currentUser.uid), { categories: { income: [], expense: [] } }, { merge: true });
      // delete transactions by reading ids then deleting (small data)
      const q = query(transactionsCollRef(currentUser.uid), orderBy("createdAt","desc"));
      // get snapshot once
      const snap = await (await import("https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js")).getDocs(q);
      const batchDeletes = [];
      snap.forEach(s=> batchDeletes.push(deleteDoc(doc(db, "users", currentUser.uid, "transactions", s.id))));
      await Promise.all(batchDeletes);
      showToast("Cleared");
    } catch(e){ alert("Clear failed: "+e.message); console.error(e); }
  };

  // CSV export
  window.exportCSV = function(){
    const rows = [["Type","Category","Amount","DateTime","Note"]];
    transactions.slice().forEach(t=>{
      rows.push([t.type, t.category, t.amount, t.datetime, t.note || ""]);
    });
    const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(",")).join("\n");
    const blob = new Blob([csv], {type:"text/csv"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "ExpenseData.csv";
    a.click();
  };

  // UI helpers
  function refreshCategorySelects(){
    const sel = document.getElementById("txCategory");
    sel.innerHTML = "";
    const type = document.getElementById("txType").value.toLowerCase();
    const list = categories[type] || [];
    list.forEach(c => {
      const o = document.createElement("option"); o.value = c; o.textContent = c; sel.appendChild(o);
    });
  }

  window.refreshCategorySelects = refreshCategorySelects;

  function renderTable(){
    const tbody = document.querySelector("#txTable tbody");
    tbody.innerHTML = "";
    transactions.slice().forEach(t=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${t.type}</td>
        <td>${t.category}</td>
        <td>${Number(t.amount).toFixed(2)}</td>
        <td>${new Date(t.datetime).toLocaleString()}</td>
        <td>${escapeHtml(t.note||"")}</td>
        <td><button onclick="deleteTx('${t._id}')" style="background:#e63946">Delete</button></td>`;
      tbody.appendChild(tr);
    });
  }

  function renderSummary(){
    const incMap = {}, expMap = {};
    transactions.forEach(t=>{
      if(t.type==="Income") incMap[t.category] = (incMap[t.category]||0) + Number(t.amount);
      else expMap[t.category] = (expMap[t.category]||0) + Number(t.amount);
    });
    const inc = Object.values(incMap).reduce((a,b)=>a+b,0);
    const exp = Object.values(expMap).reduce((a,b)=>a+b,0);
    document.getElementById("totalIncome").textContent = inc.toFixed(2);
    document.getElementById("totalExpense").textContent = exp.toFixed(2);
    document.getElementById("balance").textContent = (inc - exp).toFixed(2);
    document.getElementById("topIncome").textContent = topKey(incMap) || "-";
    document.getElementById("topExpense").textContent = topKey(expMap) || "-";
    drawPie("incomeCanvas", incMap, "incomeLegend");
    drawPie("expenseCanvas", expMap, "expenseLegend");
  }

  function renderAll(){
    refreshCategorySelects();
    renderTable();
    renderSummary();
  }

  function topKey(map){
    const keys = Object.keys(map);
    if(!keys.length) return null;
    return keys.reduce((a,b)=> map[a] > map[b] ? a : b);
  }

  // pie chart draw (same as before)
  function drawPie(canvasId, dataObj, legendId){
    const canvas = document.getElementById(canvasId);
    if(!canvas) return;
    const ctx = canvas.getContext("2d");
    // resize canvas backing store for crisp rendering
    canvas.width = canvas.clientWidth * (window.devicePixelRatio||1);
    canvas.height = canvas.clientHeight * (window.devicePixelRatio||1);
    ctx.clearRect(0,0,canvas.width,canvas.height);

    const entries = Object.entries(dataObj);
    if(entries.length === 0){
      ctx.fillStyle="#777";
      ctx.font = `${14*(window.devicePixelRatio||1)}px sans-serif`;
      ctx.fillText("No data", 10,20*(window.devicePixelRatio||1));
      document.getElementById(legendId).innerHTML = "";
      return;
    }
    const total = entries.reduce((s,[,v])=>s+v,0);
    function color(i){ return `hsl(${(i*70)%360} 70% 55%)`; }
    const cx = canvas.width/2, cy = canvas.height/2, r = Math.min(cx,cy)-10*(window.devicePixelRatio||1);
    let start = -Math.PI/2;
    entries.forEach(([label,val],i)=>{
      const slice = (val/total) * Math.PI*2;
      const end = start + slice;
      ctx.beginPath();
      ctx.moveTo(cx,cy);
      ctx.arc(cx,cy,r,start,end);
      ctx.closePath();
      ctx.fillStyle = color(i);
      ctx.fill();
      start = end;
    });
    // legend outside canvas
    const legend = document.getElementById(legendId);
    legend.innerHTML = "";
    entries.forEach(([label,val],i)=>{
      const row = document.createElement("div");
      row.className = "legend-item";
      const box = document.createElement("div");
      box.className = "legend-box"; box.style.background = color(i);
      const text = document.createElement("span");
      text.textContent = `${label} — ${val.toFixed(2)} (${((val/total)*100).toFixed(1)}%)`;
      row.appendChild(box); row.appendChild(text); legend.appendChild(row);
    });
  }

  function escapeHtml(s){ return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }

  // initial render
  renderAll();

  // small helper: fetch meta once (in case snapshot missed)
  async function fetchMetaOnce(){
    if(!currentUser) return;
    try {
      const snap = await getDoc(metaDocRef(currentUser.uid));
      if(snap.exists()){
        const d = snap.data();
        categories = d.categories || categories;
        renderAll();
      } else {
        await setDoc(metaDocRef(currentUser.uid), { categories });
      }
    } catch(e){ console.error("meta fetch error", e); }
  }

  // when auth changes, ensure meta is fetched if needed
  onAuthStateChanged(auth, user => {
    if(user) setTimeout(fetchMetaOnce, 300);
  });

</script>
</body>
</html>
